---
- name: Provision Consul server image
  hosts: default
  become: yes

  tasks:
    # Prevent services from starting during build
    - include_tasks: ../shared/tasks/packer-build-start.yml

    # Add consul-server.hcl for server nodes
    - name: Copy Consul server configuration
      copy:
        src: '../../modules/consul-server/consul-server.hcl'
        dest: /etc/consul.d/consul-server.hcl
        owner: consul
        group: consul
        mode: '0640'

    # Fix permissions for Consul configuration files
    - name: Set Consul configuration permissions
      file:
        path: /etc/consul.d
        owner: consul
        group: consul
        recurse: yes

    # Clean up temporary files
    - name: Clean temporary files
      file:
        path: '{{ item }}'
        state: absent
      loop:
        - /tmp/*
        - /var/tmp/*
      failed_when: false

    # Trim filesystem to minimize snapshot size
    - name: Trim filesystem
      command: fstrim -av

    # Note: We do NOT remove the packer_build marker here
    # It needs to stay until after the snapshot to prevent services from starting
    # It will be removed on first boot in production via cloud-init
