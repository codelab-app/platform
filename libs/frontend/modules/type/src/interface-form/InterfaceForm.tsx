import { Form, handleAsyncFormSubmit } from '@codelab/frontend/view/components'
import { autorun } from 'mobx'
import { mergeDeepRight } from 'ramda'
import React, { useEffect, useRef, useState } from 'react'
import { DeepPartial } from 'uniforms'
import { JsonSchemaTransformer } from '../store'
import { getUiProperties } from './jsonSchemaUiProperties'
import { InterfaceFormProps } from './types'

const transformer = new JsonSchemaTransformer({
  extraProperties: getUiProperties,
})

/**
 * Uniforms form generated by an {@link IInterfaceType}
 */
export const InterfaceForm = <TData,>({
  interfaceType,
  children,
  model,
  onSubmit,
  initialSchema,
  onChange,
  onSubmitError,
  onSubmitSuccess,
}: React.PropsWithChildren<InterfaceFormProps<TData>>) => {
  const initialSchemaRef = useRef(initialSchema)
  const [formSchema, setFormSchema] = useState(initialSchema ?? {})

  useEffect(
    () =>
      autorun(() => {
        const typeTreeSchema = transformer.transform(interfaceType)
        setFormSchema(mergeDeepRight(initialSchemaRef.current, typeTreeSchema))
      }),
    [interfaceType],
  )

  if (!formSchema) {
    return null
  }

  return (
    <Form
      model={model}
      onChange={onChange}
      onSubmit={handleAsyncFormSubmit<DeepPartial<TData>>(
        onSubmit as any,
        undefined,
        onSubmitSuccess as any,
        onSubmitError as any,
      )}
      onSubmitError={onSubmitError}
      onSubmitSuccess={onSubmitSuccess}
      schema={formSchema}
    >
      {children}
    </Form>
  )
}

InterfaceForm.displayName = 'InterfaceForm'
